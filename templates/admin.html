<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Survei Literasi Digital</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dashboard-body">
    {% if not session.get('admin_logged_in') %}
    <!-- ========== LOGIN FORM ========== -->
    <div class="login-overlay">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <i class="fas fa-lock"></i>
                    <h2>Admin Login</h2>
                    <p>Silakan login untuk mengakses dashboard</p>
                </div>
                
                <!-- Flash Messages -->
                <div class="flash-container">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">
                                    {% if category == 'success' %}
                                        <i class="fas fa-check-circle"></i>
                                    {% elif category == 'error' %}
                                        <i class="fas fa-exclamation-circle"></i>
                                    {% endif %}
                                    {{ message }}
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                </div>
                
                <form method="POST" action="{{ url_for('admin') }}" class="login-form">
                    <div class="form-group">
                        <label for="username"><i class="fas fa-user"></i> Username</label>
                        <input type="text" id="username" name="username" required 
                            placeholder="Masukkan username">
                    </div>
                    
                    <div class="form-group">
                        <label for="password"><i class="fas fa-key"></i> Password</label>
                        <input type="password" id="password" name="password" required 
                            placeholder="Masukkan password">
                    </div>
                    
                    <button type="submit" class="login-btn">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </form>
                
                <div class="login-footer">
                    <p><i class="fas fa-info-circle"></i> ******** </p>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- ========== DASHBOARD CONTENT ========== -->
    
    <!-- TOP NAVBAR -->
    <nav class="dashboard-nav">
        <div class="nav-left">
            <div class="nav-logo">
                <i class="fa-solid fa-chart-simple"></i>
                <span>DIGITARA</span>
            </div>
        </div>
        
        <div class="nav-right">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span>{{ session.get('admin_username', 'Admin') }}</span>
            </div>
            <a href="{{ url_for('admin_logout') }}" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </nav>

    <!-- SIDEBAR -->
    <aside class="dashboard-sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-flask-vial"></i> DataLab</h3>
        </div>
        
        <div class="sidebar-menu">
            <a href="#dashboard" class="menu-item active" onclick="showSection('dashboard')">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a href="#data" class="menu-item" onclick="showSection('data')">
                <i class="fas fa-database"></i> Data Management
            </a>
            <a href="#questions" class="menu-item" onclick="showSection('questions')">
                <i class="fas fa-edit"></i> Kelola Soal
            </a>
            <a href="{{ url_for('view_data') }}" class="menu-item">
                <i class="fas fa-table"></i> Raw Data
            </a>
            <a href="#charts" class="menu-item" onclick="showSection('charts')">
                <i class="fas fa-chart-bar"></i> Analytics
            </a>
            <a href="#export" class="menu-item" onclick="showSection('export')">
                <i class="fas fa-file-export"></i> Export
            </a>
        </div>
        
        <div class="sidebar-footer">
            <div class="system-info">
                <p><i class="fas fa-database"></i> MySQL</p>
                <p><i class="fas fa-code"></i> Flask v2.3.3</p>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="dashboard-main">
        <!-- FLASH MESSAGES -->
        <div class="flash-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            {% if category == 'success' %}
                                <i class="fas fa-check-circle"></i>
                            {% elif category == 'error' %}
                                <i class="fas fa-exclamation-circle"></i>
                            {% elif category == 'warning' %}
                                <i class="fas fa-exclamation-triangle"></i>
                            {% endif %}
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <!-- SECTION: DASHBOARD (DEFAULT) -->
        <section id="dashboard-section" class="dashboard-section active">
            <!-- WELCOME CARD -->
            <div class="welcome-card">
                <div class="welcome-content">
                    <h2>Selamat Datang, {{ session.get('admin_username', 'Admin') }}!</h2>
                    <p>Dashboard Survei Literasi Digital - Kelola dan Analisis Data Survei</p>
                    <div class="welcome-stats">
                        <span class="stat-item"><i class="fas fa-users"></i> {{ total_respondents }} Responden</span>
                        <span class="stat-item"><i class="fas fa-file-alt"></i> {{ total_surveys }} Survei</span>
                        <span class="stat-item"><i class="fas fa-chart-line"></i> {{ avg_score }}/95 Rata-rata</span>
                    </div>
                </div>
                <div class="welcome-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
            </div>

            <!-- STATS CARDS GRID -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <h3><i class="fas fa-users"></i> Total Responden</h3>
                        <span class="stat-change positive">+{{ total_respondents }} total</span>
                    </div>
                    <div class="stat-value">{{ total_respondents }}</div>
                    <div class="stat-footer">
                        <span><i class="fas fa-calendar"></i> Updated today</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <h3><i class="fas fa-file-alt"></i> Total Survei</h3>
                        <span class="stat-change positive">+{{ total_surveys }} completed</span>
                    </div>
                    <div class="stat-value">{{ total_surveys }}</div>
                    <div class="stat-footer">
                        <span><i class="fas fa-check-circle"></i> 100% completion</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <h3><i class="fas fa-chart-bar"></i> Average Score</h3>
                        <span class="stat-change neutral">{{ avg_score }}/95</span>
                    </div>
                    <div class="stat-value">{{ avg_score }}</div>
                    <div class="stat-footer">
                        <span><i class="fas fa-percentage"></i> {{ ((avg_score|default(0)/95)*100)|round(2) }}% of max</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <h3><i class="fas fa-clock"></i> Latest Activity</h3>
                        <span class="stat-change neutral">Real-time</span>
                    </div>
                    <div class="stat-value" id="realtime-update">Now</div>
                    <div class="stat-footer">
                        <span><i class="fas fa-sync-alt"></i> Auto refresh</span>
                    </div>
                </div>
            </div>

            <!-- MAIN CHARTS ROW -->
            <div class="charts-row">
                <!-- LEFT COLUMN -->
                <div class="chart-column">
                    <div class="chart-container large">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Rata-rata Skor per Kategori</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" onclick="downloadChart('categoryChart')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="chart-btn" onclick="refreshChart('categoryChart')">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="categoryChart"></canvas>
                        </div>
                        <div class="chart-footer">
                            <div class="legend">
                                <div class="legend-item">
                                    <span class="legend-color" style="background: #4CAF50;"></span>
                                    <span>Tinggi (3.8-5.0)</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color" style="background: #FFC107;"></span>
                                    <span>Sedang (2.4-3.7)</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color" style="background: #FF5252;"></span>
                                    <span>Rendah (1.0-2.3)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mini-charts-grid">
                        <div class="mini-chart">
                            <div class="mini-chart-header">
                                <h4><i class="fas fa-user-graduate"></i> Program Studi</h4>
                            </div>
                            <div class="mini-chart-body">
                                <canvas id="prodiChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="mini-chart">
                            <div class="mini-chart-header">
                                <h4><i class="fas fa-calendar-alt"></i> Distribusi Semester</h4>
                            </div>
                            <div class="mini-chart-body">
                                <canvas id="semesterChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN -->
                <div class="right-column">
                    <!-- GAUGE CHART -->
                    <div class="chart-container medium">
                        <div class="chart-header">
                            <h3><i class="fas fa-tachometer-alt"></i> Skor Keseluruhan</h3>
                            <div class="score-display">
                                <span class="score-value" id="overallScore">0.0</span>
                                <span class="score-max">/5.0</span>
                            </div>
                        </div>
                        <div class="chart-body">
                            <div class="gauge-container">
                                <canvas id="gaugeChart"></canvas>
                                <div class="gauge-label" id="gaugeLevel">Memuat...</div>
                            </div>
                        </div>
                    </div>

                    <!-- QUICK ACTIONS -->
                    <div class="quick-actions">
                        <div class="panel-header">
                            <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                        </div>
                        <div class="actions-grid">
                            <a href="/export/csv" class="action-btn">
                                <i class="fas fa-file-csv"></i>
                                <span>Export CSV</span>
                            </a>
                            <a href="/export/excel" class="action-btn">
                                <i class="fas fa-file-excel"></i>
                                <span>Export Excel</span>
                            </a>
                            <a href="/view-data" class="action-btn">
                                <i class="fas fa-table"></i>
                                <span>View Data</span>
                            </a>
                            <a href="#delete" class="action-btn delete" onclick="showDeleteModal()">
                                <i class="fas fa-trash"></i>
                                <span>Clean Data</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: DATA MANAGEMENT -->
        <section id="data-section" class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-database"></i> Data Management</h2>
                <p>Pusat pengelolaan data responden dan hasil survei.</p>
            </div>
            
            <div class="data-management-container">
                <div class="filter-header">
                    <h3><i class="fas fa-filter"></i> Filter Data</h3>
                </div>
                
                <div class="filter-body">
                    <div class="search-row-main">
                        <div class="search-input-group full-width">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Cari Nama atau NIM..." onkeyup="if(event.key === 'Enter') searchData()">
                        </div>
                    </div>

                    <div class="search-row-filters">
                        <div class="filter-group">
                            <label>Program Studi</label>
                            <div class="select-wrapper">
                                <select id="prodiFilter" class="filter-select">
                                    <option>All Programs</option>
                                    </select>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>Semester</label>
                            <div class="select-wrapper">
                                <select id="semesterFilter" class="filter-select">
                                    <option>All Semesters</option>
                                    {% for i in range(1, 15) %}
                                    <option value="{{ i }}">Semester {{ i }}</option>
                                    {% endfor %}
                                </select>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                    </div>

                    <div class="search-actions">
                        <button onclick="searchData()" class="btn-filter-action">
                            <i class="fas fa-search"></i> Terapkan Filter
                        </button>
                        <button onclick="resetFilters()" class="btn-reset-action">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <div id="searchResults" class="search-results-container">
                <div class="results-header">
                    <h4><i class="fas fa-list"></i> Hasil Pencarian</h4>
                    <span id="resultsCount" class="result-badge">0 data</span>
                </div>
                
                <div id="resultsTable" class="results-table-wrapper">
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>Gunakan filter di atas untuk menampilkan data.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: QUESTION MANAGEMENT -->
        <section id="questions-section" class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-edit"></i> Kelola Pertanyaan Survei</h2>
                <p>Ubah teks pertanyaan yang tampil di halaman survei pengguna.</p>
            </div>

            <div class="data-management-container">
                <div class="filter-header" style="justify-content: flex-end;">
                    <button onclick="openQuestionModal()" class="btn-sm" style="background: var(--primary);">
                        <i class="fas fa-plus"></i> Tambah Baru
                    </button>
                </div>
                <div class="filter-body">
                    <div class="results-scroll" style="max-height: 600px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th width="15%">Kode</th>
                                    <th width="10%">Kategori</th>
                                    <th>Pertanyaan</th>
                                    <th width="10%">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="questionTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: ANALYTICS -->
        <section id="charts-section" class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> Analytics & Insights</h2>
                <p>Detailed analysis of survey data</p>
            </div>
            
            <div class="analytics-grid">
                <div class="analytics-card full-width">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line"></i> Trends Over Time</h3>
                        <select class="time-select">
                            <option>Last 7 Days</option>
                            <option>Last 30 Days</option>
                            <option>Last 90 Days</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <div class="card-header">
                        <h3><i class="fas fa-star"></i> Top Performers</h3>
                    </div>
                    <div class="card-body">
                        <div class="top-list" id="topPerformers">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card">
                    <div class="card-header">
                        <h3><i class="fas fa-exclamation-triangle"></i> Areas for Improvement</h3>
                    </div>
                    <div class="card-body">
                        <div class="improvement-list" id="improvementAreas">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: EXPORT -->
        <section id="export-section" class="dashboard-section">
            <div class="section-header">
                <h2><i class="fas fa-file-export"></i> Export Data</h2>
                <p>Export survey data in various formats</p>
            </div>
            
            <div class="export-grid">
                <div class="export-option">
                    <div class="export-icon">
                        <i class="fas fa-file-csv"></i>
                    </div>
                    <h3>CSV Format</h3>
                    <p>Comma-separated values, compatible with Excel</p>
                    <a href="/export/csv" class="export-btn">
                        <i class="fas fa-download"></i> Download CSV
                    </a>
                </div>
                
                <div class="export-option">
                    <div class="export-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h3>Excel Format</h3>
                    <p>Microsoft Excel (.xlsx) with formatting</p>
                    <a href="/export/excel" class="export-btn">
                        <i class="fas fa-download"></i> Download Excel
                    </a>
                </div>
                
                <div class="export-option">
                    <div class="export-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <h3>PDF Report</h3>
                    <p>Printable report with charts (Coming Soon)</p>
                    <button class="export-btn disabled">
                        <i class="fas fa-clock"></i> Coming Soon
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- DELETE MODAL -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Delete Data</h3>
                <button class="close-modal" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('delete_all_testing') }}" onsubmit="return confirmDeleteAll()">
                    <div class="delete-warning">
                        <i class="fas fa-skull-crossbones"></i>
                        <p>This action will delete ALL survey data including:</p>
                        <ul>
                            <li><strong>{{ total_respondents }} Respondents</strong></li>
                            <li><strong>{{ total_surveys }} Survey Responses</strong></li>
                            <li>All analytics data</li>
                        </ul>
                        <p class="warning-text">This action cannot be undone!</p>
                    </div>
                    
                    <div class="delete-confirm">
                        <label for="confirmText">Type "DELETE_ALL" to confirm:</label>
                        <input type="text" id="confirmText" name="confirm_code" class="soft-input full mt-3" placeholder="Type DELETE_ALL" required>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                        <button type="submit" class="btn-danger">
                            <i class="fas fa-trash"></i> Delete All Data
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- QUESTION MODAL -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Kelola Pertanyaan</h3>
                <button class="close-modal" onclick="closeQuestionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="questionForm">
                    <input type="hidden" id="qId">
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Kategori</label>
                        <select id="qCategory" class="filter-select" required>
                            <option value="info">Information</option>
                            <option value="comm">Communication</option>
                            <option value="content">Content</option>
                            <option value="security">Security</option>
                            <option value="problem">Problem Solving</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Kode Soal (Otomatis)</label>
                        <input type="text" id="qCode" class="search-input" 
                            style="width: 100%; background-color: #e9ecef; cursor: not-allowed;" 
                            placeholder="(Otomatis dibuat sistem)" readonly>
                        <small style="color: #666; font-size: 12px; font-style: italic;">
                            *Kode akan diurutkan otomatis oleh sistem
                        </small>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>Isi Pertanyaan</label>
                        <textarea id="qText" class="search-input" rows="4" required style="width:100%;"></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeQuestionModal()">Batal</button>
                        <button type="submit" class="btn" style="background:var(--primary); color:white">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="{{ url_for('static', filename='dashboard.js') }}"></script>
</body>
</html>
{% endif %}